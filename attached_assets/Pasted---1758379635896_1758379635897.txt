أنشئ «معالج لصق سيناريو» يلتقط نصًا ملصوقًا من الحافظة، يقسمه إلى أسطر، يصنّف كل سطر عبر منسّق مركزي، يبني عقد DOM لكل ناتج وفق نوعه (elementType)، يطبّق قواعد تنسيق CSS دقيقة، ويقوم بتجميع العناصر في صفحات A4 ذات هوامش ثابتة مع فواصل صفحات تلقائية عند تجاوز الارتفاع القابل للاستخدام.

2) الاستيرادات (Imports)

استورد ScreenplayCoordinator من "./ScreenplayCoordinator".

استورد getFormatStyles من "./formatStyles".

استورد النوع AgentContext من "./types".

3) تعريف الصنف والمنسّق (Class & Coordinator)

عرّف صنفًا باسم ScreenplayPasteProcessor.

عرّف خاصية خاصة coordinator من النوع ScreenplayCoordinator.

في الباني (constructor):

أنشئ نسخة من ScreenplayCoordinator بتمرير المرجع getFormatStyles كوسيط للباني.

خزّن النسخة في this.coordinator.

4) الدالة الرئيسية لمعالجة اللصق processPaste(e: ClipboardEvent): Promise<void>

اجعل الدالة async وتعيد Promise<void>.

أول سطر: نفّذ e.preventDefault() لمنع السلوك الافتراضي للّصق.

استخرج النص الخام الملصوق من الحافظة: e.clipboardData?.getData("text/plain")، وخزّنه في متغيّر rawText.

إذا لم يوجد rawText أو كان فارغًا، اخرج فورًا من الدالة (return).

اقسم rawText إلى أسطر باستخدام التعبير /\r?\n/، ثم رشّح الأسطر الفارغة عبر filter((l) => l.trim() !== "")، وخزّن الناتج في مصفوفة lines.

أنشئ سياقًا فارغًا من النوع AgentContext وخزّنه في context (كائن فارغ {}).

أنشئ متغيّرًا currentPage عبر استدعاء this.createPage() (تفصيلها في قسم لاحق).

عرّف pageContentHeight = 0 كبداية.

احسب pageUsableHeight وفق: currentPage.clientHeight - (96 * 2) مع تعليق يوضح: «96px ≈ 1in (علوي + سفلي)».

الغرض: تحديد الارتفاع القابل للاستخدام داخل الصفحة الواحدة بعد طرح هوامش 1 بوصة علوية وسفلية.

حلقة المرور على الأسطر (for…of lines)

كرّر على كل line في lines:

استدعِ this.coordinator.processLine(line, context) وخزّن النتيجة في res. يجب أن يحتوي res على html وelementType.

أنشئ عنصر div جديدًا باسم block عبر document.createElement("div").

عيّن block.innerHTML = res.html لحقن الـ HTML الناتج (مباشرة من المنسّق).

طبّق قواعد التنسيق بناءً على نوع العنصر: نادِ this.applyFormattingRules(block, res.elementType).

ألحِق block إلى currentPage بواسطة currentPage.appendChild(block).

حدّث الارتفاع التراكمي: pageContentHeight += block.offsetHeight.

شرط كسر الصفحة:

إذا كان pageContentHeight >= pageUsableHeight:

ألحق currentPage إلى document.body (document.body.appendChild(currentPage)).

أنشئ صفحة جديدة: currentPage = this.createPage().

صفّر العداد: pageContentHeight = 0.

بعد اكتمال الحلقة

ألحِق الصفحة الأخيرة currentPage إلى document.body عبر document.body.appendChild(currentPage).

5) إنشاء صفحة A4 جديدة private createPage(): HTMLDivElement

أنشئ عنصر div وخزّنه في page.

عيّن page.className = "script-page".

طبّق أنماط inline عبر Object.assign(page.style, { ... }) بالقيم التالية حرفيًا:

width: "210mm"

minHeight: "297mm"

margin: "20px auto"

paddingTop: "1in"

paddingBottom: "1in"

paddingLeft: "1in"

paddingRight: "1.5in"

boxSizing: "border-box"

background: "#fff"

boxShadow: "0 0 10px rgba(0,0,0,0.15)"

overflow: "hidden"

position: "relative"

أعِد page.

6) قواعد التنسيق حسب النوع private applyFormattingRules(block: HTMLElement, type: string)

استخدم switch(type) وطبّق الكتل التالية حرفيًا عبر Object.assign(block.style, { ... }):

6.1) ترويسة المشهد (يمين/يسار)

للحالات: "scene-header-1" و"scene-header-2":

display: "flex"

justifyContent: "space-between"

fontWeight: "bold"

textTransform: "uppercase"

6.2) ترويسة مشهد وسطية

للحالة: "scene-header-3":

textAlign: "center"

fontWeight: "bold"

6.3) الأكشن

للحالة: "action":

textAlign: "right"

margin: "0.5em 1in 0.5em 1.5in"

6.4) اسم الشخصية

للحالة: "character":

textAlign: "center"

fontWeight: "bold"

margin: "1em 1.5in 0.2em 1.5in"

6.5) الحوار والإرشادات الأدائية

للحالتين: "dialogue" و"parenthetical":

textAlign: "center"

margin: "0 1.5in"

maxWidth: "calc(210mm - 3in)" ← هذه القيمة مطلوبة كما هي هنا للأنماط المضمّنة.

6.6) الانتقالات

للحالة: "transition":

textAlign: "center"

fontWeight: "bold"

textTransform: "uppercase"

margin: "1em auto"

6.7) ملاحظات المخرج

للحالة: "director-note":

fontStyle: "italic"

fontSize: "0.9em"

color: "#555"

margin: "0.5em 1in"

background: "#f5f5f5"

border: "1px solid #ddd"

borderRadius: "3px"

padding: "2px 4px"

7) أنماط CSS العمومية (تُدرج في ملف CSS خارجي كما هي)

أدرج القواعد التالية نصًا (حرفيًا) في ملف CSS مرتبط، مع مراعاة الترتيب والقيم:

/* الصفحة: A4 بهوامج ثابتة */
.script-page {
  width: 210mm;
  min-height: 297mm;
  margin: 20px auto;
  background: #fff;
  box-shadow: 0 0 10px rgba(0,0,0,0.15);
  overflow: hidden;
  box-sizing: border-box;

  /* الهوامش */
  padding-top: 1in;
  padding-bottom: 1in;
  padding-left: 1in;
  padding-right: 1.5in;
}

/* ترويسة المشهد */
.scene-header-1,
.scene-header-2 {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
  text-transform: uppercase;
}

.scene-header-3 {
  text-align: center;
  font-weight: bold;
  margin-bottom: 0.5em;
}

/* الأكشن */
.action {
  text-align: right;
  margin: 0.5em 1in 0.5em 1.5in;
}

/* الشخصية */
.character {
  text-align: center;
  font-weight: bold;
  margin: 1em 1.5in 0.2em 1.5in;
}

/* الحوار والإرشادات */
.dialogue,
.parenthetical {
  text-align: center;
  margin: 0 1.5in;
  max-width: calc(210mm - 2.5in);
  line-height: 1.4;
}

/* الانتقالات */
.transition {
  text-align: center;
  font-weight: bold;
  text-transform: uppercase;
  margin: 1em auto;
}

/* ملاحظات المخرج */
.director-note {
  font-style: italic;
  font-size: 0.9em;
  color: #555;
  margin: 0.5em 1in;
  background: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 3px;
  padding: 2px 4px;
}

/* ترقيم الصفحات (إضافة رقم سفلي) */
.script-page::after {
  content: attr(data-page);
  position: absolute;
  bottom: 0.5in;
  left: 0;
  right: 0;
  text-align: center;
  font-size: 0.8em;
  color: #333;
}


ملاحظة: أدرج القيم كما هي تمامًا. في الأنماط المضمّنة للحوار تم استخدام calc(210mm - 3in)، وفي ملف CSS تم استخدام calc(210mm - 2.5in)—التزم بالقيم النصية المعطاة كما وردت.

8) ربط التسميات (Mapping) بين الأنواع وطبقات CSS

احرص أن res.elementType القادم من المنسّق يقابل طبقة/نوعًا من الأنواع التالية:

scene-header-1, scene-header-2, scene-header-3, action, character, dialogue, parenthetical, transition, director-note.

عند بناء block.innerHTML, تأكّد أنّ العنصر الجذري داخل HTML الناتج يستخدم الطبقة الموافقة لضمان تطبيق CSS الخارجي (عند الحاجة).

9) تجميع الصفحات في المستند

كلما تجاوز التراكمي pageContentHeight قيمة pageUsableHeight:

ألحِق الصفحة الحالية في document.body.

أنشئ صفحة جديدة بنفس مواصفات createPage.

صفّر العدّاد.

بعد انتهاء الحلقة، ألحِق آخر صفحة في document.body.

10) حدود القياس والهوامش

اعتبر 96px ≈ 1in.

استخدم هوامش الصفحة كما في createPage:

أعلى: 1in، أسفل: 1in، يسار: 1in، يمين: 1.5in.

ليكن عرض الصفحة 210mm وطولها الأدنى 297mm (A4).

11) مخرجات التنفيذ المتوقعة

ملف TypeScript يصدّر الصنف ScreenplayPasteProcessor بنفس الواجهات والسلوك المحدّدين أعلاه.

إدراج الأنماط المضمّنة (inline styles) في دالة createPage كما هي نصًا.

ملف CSS خارجي يحتوي القواعد المذكورة حرفيًا، ومربوط بصفحة التشغيل.

عند لصق نص سيناريو، تُبنى صفحات A4 تلقائيًا، وتُطبّق قواعد التنسيق بنوع العنصر، وتُفصل الصفحات وفق الارتفاع القابل للاستخدام.

12) قيود صارمة

لا تغيّر أسماء الأصناف أو مفاتيح الأنماط أو القيم العددية/الوحدات المذكورة.

لا تعدّل منطق الكسر (الشرط >=).

لا تضف أي سلوك غير مذكور (مثل ترقيم الصفحات برمجيًا)، ويكفي إلحاق script-page بالـ body كما هو.

التزم باستخدام document.createElement("div") ثم block.innerHTML = res.html دون إعادة هيكلة DOM إضافية.

استدعِ applyFormattingRules في كل دورة قبل إلحاق الكتلة بالصفحة.